name: Load Tests - K6

on:
  workflow_dispatch: # Manual trigger
  schedule:
    - cron: '0 3 * * 1' # Every Monday at 3am UTC

# Only one load test at a time
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  load-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup K6
        uses: grafana/setup-k6-action@v1

      - name: Run K6 load test
        run: k6 run tests/load/eventos.test.js
        env:
          BASE_URL: ${{ secrets.LOAD_TEST_BASE_URL || secrets.E2E_BASE_URL }}
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
          SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}

      - name: Upload K6 results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-results
          path: |
            *.json
            *.html
          retention-days: 30

      - name: Generate performance summary
        if: always()
        run: |
          echo "## ðŸ“Š Load Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Target: ${BASE_URL}" >> $GITHUB_STEP_SUMMARY
          echo "- Scenario: Eventos CRUD operations" >> $GITHUB_STEP_SUMMARY
          echo "- VUs: 10 â†’ 50 (ramp up)" >> $GITHUB_STEP_SUMMARY
          echo "- Duration: ~5 minutes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ˆ Detailed metrics available in artifacts" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸš€ Load tests completed! Check the workflow run for detailed metrics.'
            })

  alert-on-failure:
    runs-on: ubuntu-latest
    needs: [load-test]
    if: failure()
    steps:
      - name: Performance degradation alert
        run: |
          echo "âš ï¸ Load test failed or performance degraded!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Action required:" >> $GITHUB_STEP_SUMMARY
          echo "1. Review K6 metrics in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. Check for database bottlenecks" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify API response times" >> $GITHUB_STEP_SUMMARY
          echo "4. Consider scaling resources" >> $GITHUB_STEP_SUMMARY
